## Question and Solution
## 🎞️ Part A: Customer Journey
```sql
SELECT
  s.customer_id,
  p.plan_id,
  p.plan_name,
  s.start_date
FROM
  foodie_fi.subscriptions AS s
  INNER JOIN foodie_fi.plans AS p ON s.plan_id = p.plan_id
WHERE
  customer_id IN (1, 2, 13, 15, 16, 18, 19);
```
## Part B: Data Analysis Questions

### Q1. How many customers has Foodie-Fi ever had?

```sql
SELECT
  COUNT (DISTINCT customer_id) total_customers
FROM
  foodie_fi.subscriptions 

```
### Q2. What is the monthly distribution of trial plan start_date values for our dataset - use the start of the month as the group by value

```sql
SELECT
  DATE_TRUNC('month', start_date)::DATE AS month_start,
  COUNT(*) AS trial_customers
FROM
  foodie_fi.subscriptions
WHERE
  plan_id = 0
GROUP BY
  month_start
ORDER BY
  month_start
```
### Q3. What plan start_date values occur after the year 2020 for our dataset? Show the breakdown by count of events for each plan_name

```sql
SELECT
  p.plan_id,
  p.plan_name,
  s.events
FROM
  foodie_fi.plans p
  INNER JOIN (
    SELECT
      plan_id,
      COUNT(*) AS events
    FROM
      foodie_fi.subscriptions
    WHERE
      start_date > '2020-12-31'
    GROUP BY
      plan_id
  ) s ON p.plan_id = s.plan_id 
```

### Q4. What is the customer count and percentage of customers who have churned rounded to 1 decimal place?


```sql
SELECT
  SUM(
    CASE
      WHEN plan_id = 4 THEN 1
      ELSE 0
    END
  ) AS churn_customers,
  ROUND(
    100 * SUM(
      CASE
        WHEN plan_id = 4 THEN 1
        ELSE 0
      END
    ) :: NUMERIC / COUNT(DISTINCT customer_id ),
    2
  ) AS percentage
FROM
  foodie_fi.subscriptions;

```
### Q5. How many customers have churned straight after their initial free trial what percentage is this rounded to 1 decimal place?

```sql
  WITH ranked_plans AS (
    SELECT
      s.customer_id,
      s.plan_id,
      s.start_date,
      p.plan_name,
      ROW_NUMBER() OVER (
        PARTITION BY s.customer_id
        ORDER BY
          s.start_date
      ) AS plan_rank
    FROM
      foodie_fi.subscriptions s
      INNER JOIN foodie_fi.plans p ON s.plan_id = p.plan_id
  )
SElECT
  SUM(
    CASE
      WHEN plan_id = 4 THEN 1
      ELSE 0
    END
  ) AS churn_customers,
  ROUND(
    100 * SUM(
      CASE
        WHEN plan_id = 4 THEN 1
        ELSE 0
      END
    ) :: NUMERIC / (
      SELECT
        COUNT (DISTINCT customer_id)
      FROM
        ranked_plans
    ),
    2
  ) AS percentage
FROM
  ranked_plans
WHERE
  plan_rank = 2
```

### Q6. What is the number and percentage of customer plans after their initial free trial?

```sql
  WITH ranked_plans AS (
    SELECT
      s.customer_id,
      s.plan_id,
      s.start_date,
      p.plan_name,
      ROW_NUMBER() OVER (
        PARTITION BY s.customer_id
        ORDER BY
          s.start_date
      ) AS plan_rank
    FROM
      foodie_fi.subscriptions s
      INNER JOIN foodie_fi.plans p ON s.plan_id = p.plan_id
  )
SElECT
  plan_id,
  plan_name,
  COUNT(*) AS customer_count,
  ROUND(COUNT(*) / SUM(COUNT(*)) Over() * 100) || '%' AS percentage
FROM
  ranked_plans
WHERE
  plan_rank = 2
GROUP BY
  plan_id,
  plan_name 

```

### Q7. What is the customer count and percentage breakdown of all 5 plan_name values at 2020-12-31?

```sql
  WITH ranked_plans AS (
    SELECT
      s.customer_id,
      s.plan_id,
      s.start_date,
      p.plan_name,
      ROW_NUMBER() OVER (
        PARTITION BY customer_id
        ORDER BY
          start_date DESC
      ) AS plan_rank
    FROM
      foodie_fi.subscriptions s
      INNER JOIN foodie_fi.plans p ON s.plan_id = p.plan_id
    WHERE
      start_date <= '2020-12-31'
  )

  SELECT
    plan_id,
    COUNT(DISTINCT customer_id) AS customers,
    ROUND(100*COUNT(DISTINCT customer_id)  / SUM(COUNT(DISTINCT customer_id)) OVER(),1) AS percentage
  FROM ranked_plans
  WHERE plan_rank = 1
  GROUP BY plan_id
```

### Q8. How many customers have upgraded to an annual plan in 2020?

```sql
SELECT
  SUM(
      CASE
        WHEN plan_id = 3 THEN 1 
        ELSE 0 
      END
      ) AS annual_customers
FROM 
foodie_fi.subscriptions
WHERE 
start_date < '2021-01-01';
```
### Q9. How many days on average does it take for a customer to an annual plan from the day they join Foodie-Fi?

```sql
WITH annual_plan AS (
  SELECT
    customer_id,
    start_date AS annual
  FROM foodie_fi.subscriptions
  WHERE plan_id = 3
),
trial AS (
  SELECT
    customer_id,
    start_date AS trial
  FROM foodie_fi.subscriptions
  WHERE plan_id = 0
)

SELECT 
ROUND (AVG ( annual - trial)) AS avg
FROM annual_plan p
INNER JOIN trial t
ON p.customer_id = t.customer_id
```

### Q10. Can you further breakdown this average value into 30 day periods (i.e. 0-30 days, 31-60 days etc)

```sql


WITH annual_plan AS (
  SELECT
    customer_id,
    start_date AS annual
  FROM foodie_fi.subscriptions
  WHERE plan_id = 3
),
trial AS (
  SELECT
    customer_id,
    start_date AS trial
  FROM foodie_fi.subscriptions
  WHERE plan_id = 0
)
,test AS (
SELECT 
p.customer_id,
p.annual, 
t.trial,
annual - trial AS duration 
FROM annual_plan p
INNER JOIN trial t
  ON p.customer_id = t.customer_id
  )
  
SELECT 
((duration / 30) * 30 || '-' || (duration / 30) * 30 + 30  || ' days' )AS breakdown_period,
COUNT(*) AS customers
FROM test
GROUP BY breakdown_period
ORDER BY customers DESC
```
